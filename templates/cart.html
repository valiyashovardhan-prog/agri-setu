<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Cart | Agri Setu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <nav class="navbar">
        <div class="logo"><i class="fas fa-shopping-cart"></i> My Cart</div>
        <a href="{{ url_for('consumer_dashboard') }}" class="btn-submit" style="width: auto; background: white; color: var(--text-main); border: 1px solid #ddd;">
            <i class="fas fa-arrow-left"></i> Continue Shopping
        </a>
    </nav>

    <div class="container" style="margin-top: 40px; max-width: 1000px;">
        
        {% if cart|length == 0 %}
        <div style="text-align: center; padding: 60px;">
            <i class="fas fa-shopping-basket fa-4x" style="color: #ddd; margin-bottom: 20px;"></i>
            <h2 style="color: #666;">Your cart is empty</h2>
            <p>Looks like you haven't added any fresh harvest yet.</p>
            <a href="{{ url_for('consumer_dashboard') }}" class="btn-submit" style="margin-top: 20px;">Start Shopping</a>
        </div>
        {% else %}

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
            
            <div class="glass-panel" style="padding: 0;">
                {% for item in cart %}
                <div class="cart-item" id="row-{{ item.id }}" style="display: flex; align-items: center; padding: 20px; border-bottom: 1px solid #eee;">
                    
                    <div style="width: 60px; height: 60px; background: #f0fdf4; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--primary-main); margin-right: 20px;">
                        <i class="fas fa-leaf"></i>
                    </div>

                    <div style="flex: 1;">
                        <h3 style="margin: 0; color: var(--text-main);">{{ item.name }}</h3>
                        <p style="margin: 5px 0 0 0; color: #666;">Unit Price: ₹<span class="u-price">{{ item.price }}</span>/kg</p>
                    </div>

                    <div style="display: flex; align-items: center; background: #f3f4f6; border-radius: 30px; padding: 5px 10px; margin-right: 20px;">
                        <button onclick="updateQty({{ item.id }}, 'decrease')" style="border:none; background:none; cursor:pointer; font-weight:bold; padding: 5px 10px;">-</button>
                        <span id="qty-{{ item.id }}" style="font-weight: bold; margin: 0 10px;">{{ item.qty }}</span>
                        <button onclick="updateQty({{ item.id }}, 'increase')" style="border:none; background:none; cursor:pointer; font-weight:bold; padding: 5px 10px;">+</button>
                    </div>

                    <div style="font-weight: bold; font-size: 1.1rem; width: 80px; text-align: right; margin-right: 20px;">
                        ₹<span class="i-total" id="total-{{ item.id }}">{{ item.price * item.qty }}</span>
                    </div>

                    <button onclick="removeItem({{ item.id }})" style="border: none; background: none; color: #ef4444; cursor: pointer; font-size: 1.1rem;">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                {% endfor %}
            </div>

            <div class="glass-panel" style="height: fit-content;">
                <h3 style="margin-bottom: 20px;">Order Summary</h3>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; color: #666;">
                    <span>Subtotal</span>
                    <span>₹<span id="subtotal">{{ total }}</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; color: #666;">
                    <span>Platform Fee</span>
                    <span style="color: var(--primary-main);">FREE</span>
                </div>
                <div style="border-top: 1px solid #eee; margin: 15px 0;"></div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 1.2rem; font-weight: bold;">
                    <span>Total</span>
                    <span>₹<span id="grand-total">{{ total }}</span></span>
                </div>

                <a href="{{ url_for('checkout') }}" class="btn-submit" style="width: 100%; justify-content: center;">
                    Checkout Now <i class="fas fa-arrow-right"></i>
                </a>
            </div>

        </div>
        {% endif %}
    </div>

    <script>
        function updateQty(itemId, action) {
            fetch('/api/update_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item_id: itemId, action: action })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    // Update UI Numbers without reloading
                    let qtySpan = document.getElementById('qty-' + itemId);
                    let currentQty = parseInt(qtySpan.innerText);
                    
                    if (action === 'increase') currentQty++;
                    else if (action === 'decrease' && currentQty > 1) currentQty--;
                    
                    qtySpan.innerText = currentQty;
                    recalcTotals();
                } else if (data.status === 'error') {
                    // SHOW ALERT IF STOCK LIMIT REACHED
                    alert(data.message);
                }
            });
        }

        function removeItem(itemId) {
            if(!confirm("Remove this item?")) return;

            fetch('/api/remove_from_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item_id: itemId })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    document.getElementById('row-' + itemId).remove();
                    recalcTotals();
                    if(document.querySelectorAll('.cart-item').length === 0) location.reload(); 
                }
            });
        }

        function recalcTotals() {
            let subtotal = 0;
            document.querySelectorAll('.cart-item').forEach(row => {
                let price = parseFloat(row.querySelector('.u-price').innerText);
                let qty = parseInt(row.querySelector('[id^="qty-"]').innerText);
                let total = price * qty;
                
                row.querySelector('.i-total').innerText = total.toFixed(1);
                subtotal += total;
            });

            document.getElementById('subtotal').innerText = subtotal.toFixed(1);
            document.getElementById('grand-total').innerText = subtotal.toFixed(1);
        }
    </script>

</body>
</html>